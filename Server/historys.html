<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeepPrinter - History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f9fafb; color: #1f2937; }
    .card { background-color: #fff; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); padding: 1rem; }
    .fixed-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; padding: 0.75rem 1rem; box-shadow: 0 -2px 4px rgba(0,0,0,0.08); z-index: 1000; }
    .status-badge { padding: 0.15rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .status-completed { background-color: #D1FAE5; color: #065F46; }  /* เขียวอ่อน */
    .status-pending { background-color: #FEF3C7; color: #92400E; }   /* ส้มอ่อน */
    .status-failed { background-color: #FEE2E2; color: #991B1B; }    /* แดงอ่อน */
    .status-paid { background-color: #FDE68A; color: #92400E; }      /* เหลืองเข้ม */
    .status-printing { background-color: #DBEAFE; color: #1E40AF; }  /* น้ำเงินอ่อน */
    .status-waiting { background-color: #FEF3C7; color: #92400E; }   /* เหลืองอ่อน */
    .label { font-size: 0.85rem; font-weight: 400; color: #374151; }
    .value { font-size: 0.9rem; color: #1f2937; }
    .ref-id { word-break: break-all; font-size: 0.8rem; color: #6b7280; }
  </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

  <div class="max-w-2xl mx-auto space-y-6 pb-20">
    <div class="flex items-center justify-between">
      <h2 id="page-title" class="text-2xl font-semibold">ประวัติการพิมพ์</h2>
      <button id="lang-toggle" class="bg-white rounded-full px-3 py-1 text-base text-gray-700 shadow hover:bg-gray-200">
        <span id="lang-text">TH</span>
      </button>
    </div>

    <div id="history-list" class="space-y-3">
      <p class="text-center text-gray-500 text-sm">⏳ กำลังโหลด...</p>
    </div>
  </div>

  <div class="fixed-footer flex items-center justify-center">
    <a id="back-link" class="text-blue-600 text-base font-medium hover:text-blue-800">
      กลับสู่หน้าหลัก
    </a>
  </div>

  <script>
    const API_BASE = "https://283d6329f959.ngrok-free.app";
    let isThai = true;

    const translations = {
      th: {
        title: "ประวัติการพิมพ์",
        back: "กลับสู่หน้าหลัก",
        loading: "⏳ กำลังโหลด...",
        loadingFailed: "❌ ไม่สามารถโหลดประวัติได้",
        noHistory: "ไม่พบประวัติการพิมพ์",
        createdAt: "สร้างเมื่อ:",
        completedAt: "เสร็จสิ้นเมื่อ:",
        printerId: "หมายเลขเครื่อง:",
        refId: "รหัสอ้างอิง:",
        paymentType: "ช่องทางชำระ:",
        totalPrice: "ยอดรวม:",
        totalPages: "จำนวนหน้า:",
        status: "สถานะ:",
        jobs: "ไฟล์ที่พิมพ์:",
        currency: "บาท",
        filename: "ชื่อไฟล์",
        pages: "หน้า",
        copies: "สำเนา",
        color: "ชนิด",
        bw: "ขาวดำ",
        full_color: "สี",
        completed: "สำเร็จ",
        pending: "รอดำเนินการ",
        failed: "ล้มเหลว",
        paid: "ชำระเงินแล้ว",
        printing: "กำลังพิมพ์",
        waiting: "รอการชำระเงิน"
      },
      en: {
        title: "Print History",
        back: "Back to Main Page",
        loading: "⏳ Loading...",
        loadingFailed: "❌ Failed to load history",
        noHistory: "No print history found",
        createdAt: "Created At:",
        completedAt: "Completed At:",
        printerId: "Printer ID:",
        refId: "Reference ID:",
        paymentType: "Payment Type:",
        totalPrice: "Total Price:",
        totalPages: "Total Pages:",
        status: "Status:",
        jobs: "Printed Files:",
        currency: "Baht",
        filename: "Filename",
        pages: "Pages",
        copies: "Copies",
        color: "Type",
        bw: "B&W",
        full_color: "Color",
        completed: "Completed",
        pending: "Pending",
        failed: "Failed",
        paid: "Paid",
        printing: "Printing",
        waiting: "Waiting for Payment"
      }
    };

    function getLineIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("uid");
    }

    function formatDate(isoString) {
      if (!isoString) return "-";
      const date = new Date(isoString);
      const bangkokDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
      return bangkokDate.toLocaleString(isThai ? 'th-TH' : 'en-US', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function getStatusText(status) {
      const langData = translations[isThai ? 'th' : 'en'];
      if (!status) return "-";
      const normalized = status.toString().trim().toLowerCase();
      switch(normalized) {
        case 'completed': return langData.completed;
        case 'pending': return langData.pending;
        case 'failed': return langData.failed;
        case 'paid': return langData.paid;
        case 'printing': return langData.printing;
        case 'waiting': return langData.waiting;
        default: return status;
      }
    }

    async function loadPrintHistory(lineId) {
      const listDiv = document.getElementById("history-list");
      const langData = translations[isThai ? 'th' : 'en'];
      listDiv.innerHTML = `<p class="text-center text-gray-500 text-sm">${langData.loading}</p>`;

      try {
        const res = await fetch(`${API_BASE}/get_payment_history/${lineId}`);
        if (!res.ok) throw new Error("API call failed");
        const data = await res.json();

        listDiv.innerHTML = "";
        if (data.history && data.history.length > 0) {
          // ✅ เรียงตาม created_at จากล่าสุด → เก่าสุด
          data.history.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          data.history.forEach(item => {
            const normalizedStatus = item.status ? item.status.toString().trim().toLowerCase() : "-";
            const statusClass = `status-badge status-${normalizedStatus}`;
            const statusText = getStatusText(item.status);

            let jobsHtml = "";
            if (item.jobs && item.jobs.length > 0) {
              jobsHtml = item.jobs.map(job => {
                const colorText = job.color === 'bw' ? langData.bw : langData.full_color;
                return `
                  <div class="p-2 bg-gray-50 rounded">
                    <p class="text-sm font-normal">${langData.filename}: ${job.filename}</p>
                    <ul class="text-xs text-gray-600 ml-4">
                      <li>${langData.pages}: ${job.pages}</li>
                      <li>${langData.copies}: ${job.copies}</li>
                      <li>${langData.color}: ${colorText}</li>
                    </ul>
                  </div>
                `;
              }).join("");
            }

            const refDisplay = item.ref_id 
              ? item.ref_id.substring(0, 8) + "..." + item.ref_id.slice(-6) 
              : "-";

            const card = document.createElement("div");
            card.className = "card space-y-1";

            card.innerHTML = `
              <p class="text-sm"><span class="label">${langData.createdAt}</span> <span class="value">${formatDate(item.created_at)}</span></p>
              <p class="text-sm"><span class="label">${langData.completedAt}</span> <span class="value">${formatDate(item.completed_at)}</span></p>
              <p class="text-sm"><span class="label">${langData.totalPrice}</span> <span class="value">${(item.total_amount || 0).toFixed(2)} ${langData.currency}</span></p>
              <p class="text-sm"><span class="label">${langData.totalPages}</span> <span class="value">${item.total_pages || 0}</span></p>
              <p class="text-sm"><span class="label">${langData.status}</span> <span class="${statusClass}">${statusText}</span></p>
              <p class="text-sm"><span class="label">${langData.printerId}</span> <span class="value">${item.printer_id || '-'}</span></p>
              <p class="text-sm"><span class="label">${langData.refId}</span> <span class="ref-id">${refDisplay}</span></p>
              <p class="text-sm"><span class="label">${langData.paymentType}</span> <span class="value">${item.payment_type || '-'}</span></p>
              <div class="border-t pt-2">
                <p class="label">${langData.jobs}</p>
                ${jobsHtml || `<p class="text-xs text-gray-500">-</p>`}
              </div>
            `;

            listDiv.appendChild(card);
          });
        } else {
          listDiv.innerHTML = `<p class="text-center text-gray-500 text-sm">${langData.noHistory}</p>`;
        }
      } catch (err) {
        listDiv.innerHTML = `<p class="text-center text-red-600 text-sm">${langData.loadingFailed}</p>`;
        console.error("Error loading history:", err);
      }
    }

    function updateLanguage(lang) {
      const langData = translations[lang];
      document.getElementById('page-title').textContent = langData.title;
      document.querySelector('#lang-text').textContent = lang.toUpperCase();
      document.getElementById('back-link').textContent = langData.back;
      const lineId = getLineIdFromURL();
      if(lineId) loadPrintHistory(lineId);
    }

    document.getElementById('lang-toggle').addEventListener('click', () => {
      isThai = !isThai;
      updateLanguage(isThai ? 'th' : 'en');
    });

    document.addEventListener('DOMContentLoaded', () => {
      const lineId = getLineIdFromURL();
      updateLanguage(isThai ? 'th' : 'en');
      if (lineId) {
        document.getElementById('back-link').href = `index.html?uid=${lineId}`;
        loadPrintHistory(lineId);
      } else {
        document.getElementById('history-list').innerHTML =
          `<p class='text-red-600 text-center text-sm'>UID not found</p>`;
        document.getElementById('back-link').href = 'index.html';
      }
    });
  </script>
</body>
</html>
