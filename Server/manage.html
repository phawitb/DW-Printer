<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif !important; background-color: #f9fafb; color: #1f2937; }
    .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
  </style>
</head>
<body class="bg-gray-100 p-6 md:p-12">
  <div class="max-w-3xl mx-auto space-y-6">

    <!-- Title -->
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold">üñ®Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
    </div>

    <!-- Card: Printer Search -->
    <div class="card p-6 space-y-4">
      <label class="block text-lg font-semibold">Printer ID</label>
      <div class="flex flex-col sm:flex-row gap-3">
        <input id="printerId" type="text" class="border px-4 py-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô P0001">
        <button onclick="loadPrinter()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">
          ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </div>

    <!-- Card: Printer Form -->
    <form id="printerForm" class="card p-6 space-y-5 hidden" onsubmit="savePrinter(event)">
      <div>
        <label class="block text-lg font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="location_name" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
        <div>
          <label class="block text-lg font-semibold">Latitude</label>
          <input id="lat" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
        <div>
          <label class="block text-lg font-semibold">Longitude</label>
          <input id="lon" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
      </div>

      <div>
        <label class="block text-lg font-semibold">URL</label>
        <input id="url" class="border px-4 py-3 w-full rounded-lg bg-gray-200 text-gray-500" disabled>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
        <div>
          <label class="block text-lg font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥</label>
          <input id="bw_price" type="number" step="0.01" min="0"
                 class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
        <div>
          <label class="block text-lg font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏™‡∏µ</label>
          <input id="color_price" type="number" step="0.01" min="0"
                 class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
      </div>

      <div>
        <label class="block text-lg font-semibold">‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</label>
        <select id="bw_only" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
        <div>
          <label class="block text-lg font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î</label>
          <input id="open_time" type="time" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
        <div>
          <label class="block text-lg font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î</label>
          <input id="close_time" type="time" class="border px-4 py-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
      </div>

      <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition w-full sm:w-auto">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    </form>
  </div>

  <script>
    let API_BASE = "";
    let LIFF_ID  = "";
    let lineUid  = null;

    async function loadConfig() {
      const res = await fetch("/static/config.json", { cache: "no-store" });
      const cfg = await res.json();
      API_BASE = cfg.API_BASE;
      LIFF_ID  = cfg.LIFF_ID;
      console.log("‚úÖ Config loaded:", cfg);
    }

    async function initLiff() {
      await loadConfig();
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) return liff.login();
      const profile = await liff.getProfile();
      lineUid = profile.userId;
      console.log("üë§ Current UID:", lineUid);
    }

    async function loadPrinter() {
      const id = document.getElementById("printerId").value.trim();
      if (!id) return alert("‡∏Å‡∏£‡∏≠‡∏Å printer_id ‡∏Å‡πà‡∏≠‡∏ô");

      const res = await fetch(API_BASE + `/get_printer/${id}`, {
        headers: { "X-Line-Uid": lineUid }
      });
      if (!res.ok) {
        console.error("‚ùå Error get_printer:", await res.text());
        return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå");
      }

      const data = await res.json();
      document.getElementById("printerForm").classList.remove("hidden");

      for (const key in data) {
        if (document.getElementById(key)) {
          document.getElementById(key).value = data[key];
        }
      }

      if (!data.open_time) document.getElementById("open_time").value = "00:00";
      if (!data.close_time) document.getElementById("close_time").value = "23:59";
    }

    async function savePrinter(event) {
        event.preventDefault();
        const id = document.getElementById("printerId").value.trim();
        const payload = {};
        ["location_name","lat","lon","url","bw_price","color_price","bw_only","open_time","close_time"].forEach(k=>{
            payload[k] = document.getElementById(k).value;
        });
        payload["bw_price"] = parseFloat(payload["bw_price"]);
        payload["color_price"] = parseFloat(payload["color_price"]);
        payload["bw_only"] = payload["bw_only"] === "true";

        const res = await fetch(API_BASE + `/update_printer/${id}`, {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            "X-Line-Uid": lineUid
            },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        console.log("üìå update_printer response:", data);
        alert(data.message || JSON.stringify(data));
    }

    window.onload = initLiff;
  </script>
</body>
</html>
