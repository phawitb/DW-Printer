<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeepPrinter Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif !important; background-color: #f9fafb; color: #1f2937; }
    .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s, box-shadow 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .hidden { display: none; }
    #map { height: 500px; border-radius: 12px; }
    .tab-btn { display:flex; align-items:center; justify-content:center; padding:10px; border-radius:8px; font-weight:500; flex:1; cursor: pointer; }
    .tab-active { background-color:#52575f; color:#fff; }
    .tab-inactive { background-color:#E5E7EB; color:#52575f; }
    .nav-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:#EFF6FF; color:#2563EB; border-radius:20px; font-size:14px; font-weight:500; text-decoration:none; }
    .nav-btn:hover { background:#DBEAFE; }
    .nav-btn img { width:16px; height:16px; }
    .select-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:#2563EB; color:#fff; border-radius:20px; font-size:14px; font-weight:500; text-decoration:none; cursor: pointer; }
    .select-btn:hover { background:#1E40AF; }
    .select-btn img { width:16px; height:16px; }
    @keyframes rainbow { 0%{color:red;} 14%{color:orange;} 28%{color:yellow;} 42%{color:green;} 57%{color:blue;} 71%{color:indigo;} 85%{color:violet;} 100%{color:red;} }
    .rainbow-text { animation: rainbow 4s linear infinite; }
  </style>
</head>
<body class="bg-gray-100 p-6 md:p-12">
  <div class="max-w-3xl mx-auto space-y-6">
    <div class="flex items-center justify-between mb-4">
      <h2 id="page-title" class="text-2xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
      <button id="lang-toggle" class="bg-white rounded-full p-2 text-gray-700 shadow-md hover:bg-gray-200">
        <span id="lang-text">TH</span>
      </button>
    </div>

    <div class="flex space-x-2">
      <button id="list-tab" class="tab-btn tab-active">
        <span id="list-tab-text">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </button>
      <button id="map-tab" class="tab-btn tab-inactive">
        <span id="map-tab-text">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
      </button>
    </div>

    <div id="loading-spinner" class="flex justify-center items-center h-48">
      <div class="loader border-4 border-gray-200 border-t-blue-500 rounded-full w-10 h-10 animate-spin"></div>
    </div>

    <div id="list-view" class="space-y-4"></div>

    <div id="map-view" class="hidden">
      <div id="map"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://dw-printer-lts.onrender.com";
    let isThai = true;
    let printerMap = {};
    let userCoords = null;
    let map;
    let lineId = new URLSearchParams(window.location.search).get("uid");

    // --- Icon paths ---
    const printerIconPath = "images/printer.png";
    const navigateIconPath = "images/navigate.png";

    // --- Translations ---
    const translations = {
      th: {
        title: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå", list: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", map: "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà",
        loadingFailed: "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", noPrinterFound: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå", km: "‡∏Å‡∏°.",
        online: "üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", offline: "üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå",
        select: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ", nav: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á",
        color_printer: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏µ", bw_printer: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥",
        color: "‡∏™‡∏µ", bw: "‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥", baht: "‡∏ö‡∏≤‡∏ó",
        operating_hours: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£",
        outside_hours_confirm: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (${open_time} - ${close_time})\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
      },
      en: {
        title: "Select a Printer", list: "List", map: "Map",
        loadingFailed: "‚ùå Failed to load printers", noPrinterFound: "No printers found", km: "km",
        online: "üü¢ Online", offline: "üî¥ Offline",
        select: "Select printer", nav: "Navigation",
        color_printer: "Color Printer", bw_printer: "Black-and-White Printer",
        color: "Color", bw: "Black-and-White", baht: "Baht",
        operating_hours: "Hours",
        outside_hours_confirm: "The printer is outside of operating hours (${open_time} - ${close_time}).\nDo you want to continue?"
      }
    };

    // --- Custom Leaflet Icons ---
    const greenIcon = L.icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    const redIcon = L.icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    function updateLanguage(lang) {
      const langData = translations[lang];
      document.getElementById('page-title').textContent = langData.title;
      document.getElementById('lang-text').textContent = lang.toUpperCase();
      document.getElementById('list-tab-text').textContent = langData.list;
      document.getElementById('map-tab-text').textContent = langData.map;
    }

    async function getLocation(opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => reject(err),
          opts
        );
      });
    }

    async function loadPrinters() {
      const listView = document.getElementById("list-view");
      const loadingSpinner = document.getElementById("loading-spinner");
      const lang = isThai ? 'th' : 'en';
      const t = translations[lang];

      loadingSpinner.classList.remove('hidden');
      listView.innerHTML = '';
      printerMap = {};

      let url = `${API_BASE}/get_all_printer`;
      try {
        const { lat, lon } = await getLocation();
        userCoords = { lat, lon };
        url = `${url}?user_lat=${lat}&user_lon=${lon}`;
      } catch {}

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        data.printers.forEach(p => { printerMap[p.printer_id] = p; });
        renderListView(data.printers);
        renderMapView(data.printers);
      } catch (err) {
        listView.innerHTML = `<p class='text-red-600 text-center'>${t.loadingFailed}</p>`;
      } finally {
        loadingSpinner.classList.add('hidden');
      }
    }

    function renderListView(printers) {
      const listView = document.getElementById("list-view");
      const lang = isThai ? 'th' : 'en';
      const t = translations[lang];

      if (printers.length === 0) {
        listView.innerHTML = `<p class='text-gray-500 text-center'>${t.noPrinterFound}</p>`;
        return;
      }

      printers.sort((a, b) => {
        if (typeof a.distance_km !== 'number') return 1;
        if (typeof b.distance_km !== 'number') return -1;
        return a.distance_km - b.distance_km;
      });

      listView.innerHTML = '';
      printers.forEach(printer => {
        const card = document.createElement("div");
        card.className = `card p-4 space-y-3 ${printer.status !== 'online' ? 'opacity-60 bg-gray-50' : ''}`;
        
        const statusText = printer.status === 'online' ? t.online : t.offline;
        const distText = (typeof printer.distance_km === "number") ? ` ‚Ä¢ ${printer.distance_km.toFixed(2)} ${t.km}` : '';
        const operatingHours = printer.open_time && printer.close_time 
            ? `<p class="text-sm text-gray-600 mt-1">üïí ${t.operating_hours}: ${printer.open_time} - ${printer.close_time}</p>` 
            : '';

        let typeAndPriceHtml;
        if (printer.bw_only) {
          typeAndPriceHtml = `
              <p class="text-sm text-gray-500"><span class="font-bold">${t.bw_printer}</span>${distText}</p>
              <p class="text-sm text-gray-600">${t.bw}: ${printer.bw_price} ${t.baht}</p>
              ${operatingHours}`;
        } else {
          typeAndPriceHtml = `
              <p class="text-sm text-gray-500"><span class="rainbow-text font-bold">${t.color_printer}</span>${distText}</p>
              <div class="text-sm text-gray-600">
                  <span>${t.bw}: ${printer.bw_price} ${t.baht}</span> | 
                  <span>${t.color}: ${printer.color_price} ${t.baht}</span>
              </div>
              ${operatingHours}`;
        }

        const selectBtn = (printer.status === 'online')
          ? `<button onclick="event.stopPropagation(); selectPrinter('${printer.printer_id}')" class="select-btn">
                <img src="${printerIconPath}" alt="printer"/> <span>${t.select}</span>
             </button>`
          : '';

        const navBtn = (printer.lat && printer.lon)
          ? `<a href="https://www.google.com/maps/dir/?api=1&destination=${printer.lat},${printer.lon}" target="_blank" onclick="event.stopPropagation();" class="nav-btn">
                <img src="${navigateIconPath}" alt="nav"/> <span>${t.nav}</span>
             </a>`
          : '';

        card.innerHTML = `
            <div class="flex items-start justify-between">
                <h4 class="text-lg font-semibold">${printer.location_name}</h4>
                <span class="text-sm font-medium ${printer.status === 'online' ? 'text-green-600' : 'text-red-600'}">${statusText}</span>
            </div>
            ${typeAndPriceHtml}
            <div class="flex gap-2 pt-2">
                ${selectBtn}
                ${navBtn}
            </div>`;
        listView.appendChild(card);
      });
    }

    function renderMapView(printers) {
      const lang = isThai ? 'th' : 'en';
      const t = translations[lang];

      if (!map) {
        map = L.map('map').setView([13.736717, 100.523186], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
      }

      map.eachLayer(layer => { if (layer instanceof L.Marker || layer instanceof L.CircleMarker) map.removeLayer(layer); });

      if (userCoords) {
        L.circleMarker([userCoords.lat, userCoords.lon], {
          color: "white", fillColor: "#2563EB", fillOpacity: 1, radius: 8, weight: 2
        }).addTo(map).bindPopup("üìç " + (isThai ? "‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" : "You are here"));
        
        map.setView([userCoords.lat, userCoords.lon], 14);
      }

      printers.forEach(printer => {
        if (printer.lat && printer.lon) {
          const typeText = printer.bw_only ? `<span class="font-bold">${t.bw_printer}</span>` : `<span class="rainbow-text font-bold">${t.color_printer}</span>`;
          const priceTextBw = `${t.bw}: ${printer.bw_price} ${t.baht}`;
          const priceTextColor = printer.bw_only ? '' : `<br>${t.color}: ${printer.color_price} ${t.baht}`;
          const operatingHoursHtml = printer.open_time && printer.close_time 
                ? `üïí ${t.operating_hours}: ${printer.open_time} - ${printer.close_time}<br>` 
                : '';
          const navButtonHtml = `<a href="https://www.google.com/maps/dir/?api=1&destination=${printer.lat},${printer.lon}" target="_blank" class="nav-btn" style="width: 100%; justify-content: center;">
                                   <img src="${navigateIconPath}" alt="nav"/> <span>${t.nav}</span>
                                 </a>`;

          let marker, popupContent;
          if (printer.status === 'online') {
            marker = L.marker([printer.lat, printer.lon], { icon: greenIcon }).addTo(map);
            const selectButtonHtml = `<button onclick="selectPrinter('${printer.printer_id}')" class="select-btn" style="width: 100%; justify-content: center;">
                                        <img src="${printerIconPath}" alt="printer"/> <span>${t.select}</span>
                                      </button>`;
            popupContent = `
              <b>${printer.location_name}</b><br>
              ${typeText}<br>
              <b style="color:green;">${t.online}</b><br>
              ${operatingHoursHtml}
              ${priceTextBw}
              ${priceTextColor}<br>
              <div class="mt-2 flex flex-col gap-2">
                ${selectButtonHtml}
                ${navButtonHtml}
              </div>`;
          } else {
            marker = L.marker([printer.lat, printer.lon], { icon: redIcon }).addTo(map);
            popupContent = `
              <b>${printer.location_name}</b><br>
              ${typeText}<br>
              <b style="color:red;">${t.offline}</b><br>
              ${operatingHoursHtml}
              ${priceTextBw}
              ${priceTextColor}<br>
              <div class="mt-2">
                ${navButtonHtml}
              </div>`;
          }
          marker.bindPopup(popupContent);
        }
      });
    }

    function selectPrinter(printerId) {
      const printer = printerMap[printerId];
      if (!printer) return;

      const proceedAction = () => {
        const params = new URLSearchParams();
        if (lineId) params.set('uid', lineId);
        params.set('selected_printer', printerId);
        window.location.href = `index.html?${params.toString()}`;
      };

      if (printer.open_time && printer.close_time) {
        const lang = isThai ? 'th' : 'en';
        const t = translations[lang];
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        const [openHour, openMin] = printer.open_time.split(':').map(Number);
        const openMinutes = openHour * 60 + openMin;

        const [closeHour, closeMin] = printer.close_time.split(':').map(Number);
        const closeMinutes = closeHour * 60 + closeMin;

        let isOpen = false;
        if (openMinutes <= closeMinutes) {
          if (currentMinutes >= openMinutes && currentMinutes < closeMinutes) {
            isOpen = true;
          }
        } else {
          if (currentMinutes >= openMinutes || currentMinutes < closeMinutes) {
            isOpen = true;
          }
        }

        if (isOpen) {
          proceedAction();
        } else {
          let message = t.outside_hours_confirm
              .replace('${open_time}', printer.open_time)
              .replace('${close_time}', printer.close_time);
          if (confirm(message)) {
            proceedAction();
          }
        }
      } else {
        proceedAction();
      }
    }

    // --- Event Listeners ---
    document.getElementById('list-tab').addEventListener('click', () => {
      document.getElementById('list-view').classList.remove('hidden');
      document.getElementById('map-view').classList.add('hidden');
      document.getElementById('list-tab').classList.add('tab-active');
      document.getElementById('list-tab').classList.remove('tab-inactive');
      document.getElementById('map-tab').classList.add('tab-inactive');
      document.getElementById('map-tab').classList.remove('tab-active');
    });

    document.getElementById('map-tab').addEventListener('click', () => {
      document.getElementById('map-view').classList.remove('hidden');
      document.getElementById('list-view').classList.add('hidden');
      document.getElementById('map-tab').classList.add('tab-active');
      document.getElementById('map-tab').classList.remove('tab-inactive');
      document.getElementById('list-tab').classList.add('tab-inactive');
      document.getElementById('list-tab').classList.remove('tab-active');
      if (map) setTimeout(() => map.invalidateSize(), 10);
    });

    document.getElementById('lang-toggle').addEventListener('click', () => {
      isThai = !isThai;
      updateLanguage(isThai ? 'th' : 'en');
      loadPrinters();
    });

    // --- Initial Load ---
    loadPrinters();
    updateLanguage('th');
  </script>
</body>
</html>
