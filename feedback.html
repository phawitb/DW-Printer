<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif !important; background-color: #f9fafb; color: #1f2937; }
    .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .btn { padding:10px 16px; border-radius:8px; font-weight:500; cursor:pointer; }
    .btn-primary { background:#2563EB; color:#fff; }
    .btn-primary:hover { background:#1E40AF; }
    .hidden { display:none; }
  </style>
</head>
<body class="bg-gray-100 p-6 md:p-12">
  <div class="max-w-2xl mx-auto space-y-6">
    <div class="flex items-center justify-between mb-4">
      <h2 id="page-title" class="text-2xl font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</h2>
      <button id="lang-toggle" class="bg-white rounded-full p-2 text-gray-700 shadow-md hover:bg-gray-200">
        <span id="lang-text">TH</span>
      </button>
    </div>

    <!-- Feedback Form -->
    <div id="form-card" class="card p-6 space-y-4">
      <div>
        <label class="block font-semibold mb-1" id="label-topic">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
        <select id="topic" class="w-full border rounded px-3 py-2" required>
          <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</option>
          <option value="refund">‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
          <option value="printer_error">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏µ‡∏¢</option>
          <option value="no_power">‡πÑ‡∏ü‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤</option>
          <option value="paper_jam">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏¥‡∏î</option>
          <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1" id="label-message">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <textarea id="message" class="w-full border rounded px-3 py-2" rows="4" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." required></textarea>
      </div>
      <button id="submit-btn" class="btn btn-primary w-full">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>

    <!-- Success Message -->
    <div id="success-card" class="card p-6 text-center hidden">
      <img src="images/payment-success.png" alt="success" class="mx-auto w-24 mb-4">
      <p id="success-text" class="text-lg font-semibold text-green-600">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</p>
    </div>

    <!-- Contact -->
    <div class="card p-6">
      <h3 class="text-lg font-semibold mb-2" id="contact-title">üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
      <ul class="space-y-1 text-gray-700">
        <li id="contact1">‡πÄ‡∏ö‡∏≠‡∏£‡πå 1: <a href="tel:0800000001" class="text-blue-600 hover:underline">080-000-0001</a></li>
        <li id="contact2">‡πÄ‡∏ö‡∏≠‡∏£‡πå 2: <a href="tel:0800000002" class="text-blue-600 hover:underline">080-000-0002</a></li>
      </ul>
    </div>
  </div>

  <script>
    let isThai = true;
    let userId = "anonymous"; 
    let LIFF_ID = null;

    async function loadConfig() {
      try {
        const res = await fetch("/static/config.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Config load failed");
        const cfg = await res.json();
        LIFF_ID = cfg.LIFF_ID;
        console.log("‚úÖ Config loaded:", cfg);
        await initLiff();
      } catch (err) {
        console.error("Error loading config:", err);
      }
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          userId = profile.userId;
          console.log("LINE UserID:", userId);
        } else {
          liff.login();
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    async function sendFeedback() {
      const topic = document.getElementById("topic").value;
      const message = document.getElementById("message").value.trim();
      if (!topic || !message) {
        alert(isThai ? "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö" : "Please fill all fields");
        return;
      }

      const payload = {
        uid: userId,
        topic,
        message
      };

      try {
        const res = await fetch("/sent_feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);

        document.getElementById("form-card").classList.add("hidden");
        document.getElementById("success-card").classList.remove("hidden");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    document.getElementById("submit-btn").addEventListener("click", sendFeedback);

    // === Language toggle ===
    const translations = {
      th: {
        title:"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á",
        topic:"‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠",
        message:"‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î",
        submit:"‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
        success:"‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
        contact:"üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà",
        placeholderMessage:"‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤...",
        topicOptions: [
          { value: "refund", text: "‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" },
          { value: "printer_error", text: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏µ‡∏¢" },
          { value: "no_power", text: "‡πÑ‡∏ü‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤" },
          { value: "paper_jam", text: "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏¥‡∏î" },
          { value: "other", text: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" }
        ],
        contacts: ["‡πÄ‡∏ö‡∏≠‡∏£‡πå 1: 080-000-0001", "‡πÄ‡∏ö‡∏≠‡∏£‡πå 2: 080-000-0002"]
      },
      en: {
        title:"Report Printer Issue",
        topic:"Topic",
        message:"Description",
        submit:"Submit Report",
        success:"Your report has been submitted successfully",
        contact:"üìû Contact Support",
        placeholderMessage:"Describe the issue...",
        topicOptions: [
          { value: "refund", text: "Refund Request" },
          { value: "printer_error", text: "Printer Malfunction" },
          { value: "no_power", text: "No Power" },
          { value: "paper_jam", text: "Paper Jam" },
          { value: "other", text: "Other" }
        ],
        contacts: ["Contact 1: 080-000-0001", "Contact 2: 080-000-0002"]
      }
    };

    function updateLanguage(lang) {
      const t = translations[lang];
      document.getElementById("page-title").textContent = t.title;
      document.getElementById("label-topic").textContent = t.topic;
      document.getElementById("label-message").textContent = t.message;
      document.getElementById("submit-btn").textContent = t.submit;
      document.getElementById("success-text").textContent = t.success;
      document.getElementById("contact-title").textContent = t.contact;
      document.getElementById("lang-text").textContent = lang.toUpperCase();
      document.getElementById("message").placeholder = t.placeholderMessage;

      // update topics
      const topicSelect = document.getElementById("topic");
      topicSelect.innerHTML = `<option value="" disabled selected>${lang === "th" ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" : "Select a Topic"}</option>`;
      t.topicOptions.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.text;
        topicSelect.appendChild(option);
      });

      // update contacts
      document.getElementById("contact1").innerHTML = t.contacts[0].replace(/(080-\d+-\d+)/, '<a href="tel:$1" class="text-blue-600 hover:underline">$1</a>');
      document.getElementById("contact2").innerHTML = t.contacts[1].replace(/(080-\d+-\d+)/, '<a href="tel:$1" class="text-blue-600 hover:underline">$1</a>');
    }

    document.getElementById("lang-toggle").addEventListener("click", () => {
      isThai = !isThai;
      updateLanguage(isThai ? "th" : "en");
    });

    // Initial
    updateLanguage("th");
    loadConfig(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î config.json ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß init LIFF
  </script>
</body>
</html>
